{% extends "base.html" %}

{% block content %}
<h1>Конфигурация</h1>
<div id="url-connecion-forms">
    <div id="add-connection-form">
        <input type="text" id="newNameField" placeholder="Введите имя камеры">
        <input type="text" id="newTextField" placeholder="Введите URL-адрес камеры">
        <button onclick="addTextField()">Добавить</button>
    </div>
    <div class="connection-item header" style="margin-bottom: 10px;">
        <span>ID</span>
        <span style="padding-right: 38%;">Имя камеры</span>
        <span>URL-адрес камеры</span>
    </div>
    <div id="list-connection-form">
        
        {% for config in configs %}
        <div class="connection-item" id="field-{{ config.id }}">
            <span>{{ config.id }}</span>
            <input type="text" value="{{ config.name }}" disabled>
            <input type="text" value="{{ config.url }}" disabled>
            <button onclick="deleteTextField({{ config.id }})">Удалить</button>
        </div>
        {% endfor %}
    </div>
</div>

<div id="pagination">
    <button id="prev-page" onclick="changePage({{ current_page - 1 }})" {% if current_page == 1 %}disabled{% endif %}>Предыдущая</button>
    <span id="current-page">{{ current_page }}</span> / <span id="total-pages">{{ total_pages }}</span>
    <button id="next-page" onclick="changePage({{ current_page + 1 }})" {% if current_page == total_pages %}disabled{% endif %}>Следующая</button>
</div>

<script>
    async function loadTextFields(newConfig) {
        const container = document.getElementById("list-connection-form");

        const newDiv = document.createElement('div');
        newDiv.className = 'connection-item';
        newDiv.id = `field-${newConfig.id}`;

        const idSpan = document.createElement('span');
        idSpan.textContent = `${newConfig.id}`;

        const newNameInput = document.createElement('input');
        newNameInput.type = 'text';
        newNameInput.value = newConfig.name;
        newNameInput.disabled = true;

        const newUrlInput = document.createElement('input');
        newUrlInput.type = 'text';
        newUrlInput.value = newConfig.url;
        newUrlInput.disabled = true;

        const deleteButton = document.createElement('button');
        deleteButton.textContent = 'Удалить';
        deleteButton.onclick = async function() {
            await deleteTextField(newConfig.id);
            newDiv.remove();
        };

        newDiv.appendChild(idSpan);
        newDiv.appendChild(newNameInput);
        newDiv.appendChild(newUrlInput);
        newDiv.appendChild(deleteButton);
        container.insertBefore(newDiv, container.firstChild);
    }



    async function addTextField() {
        const inputName = document.getElementById('newNameField');
        const name = inputName.value;

        const inputUrl = document.getElementById('newTextField');
        const url = inputUrl.value;
        
        if (url && name) {
            const response = await fetch(`camera_config`, {
                method: "PUT",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({ name: name, url: url }),
            });
            if (!response.ok) {
                console.error('Error adding url connection form:', await response.json());
            }
            const newConfig = await response.json();
            loadTextFields(newConfig.camera_config);
            inputName.value = '';
            inputUrl.value = '';
        }
    }

    async function deleteTextField(id) {
        const response = await fetch(`camera_config/${id}`, {
            method: "DELETE",
        });
        if (!response.ok) {
            console.error('Error deleting url connection form:', await response.json());
        }
        else {
            const divToRemove = document.getElementById(`field-${id}`);
            if (divToRemove) {
                divToRemove.remove();
            }
        }
    }

    async function changePage(page) {
        const response = await fetch(`/configuration?page=${page}`, {
            method: "GET",
        });
        if (response.ok) {
            const html = await response.text();
            document.body.innerHTML = html;
        } else {
            console.error('Error changing page:', await response.json());
        }
    }
</script>

{% endblock %}
